<!--
Last updated: 2025-04-16 11:12 EDT
NOTE: Update this timestamp whenever the document is updated.
-->

# Database Schema Documentation

This document provides a comprehensive explanation of the database schema used in the Injury Reporting App. It details each table, its purpose, attributes, and relationships.

## Overview

The application uses a PostgreSQL database hosted on Supabase with three main tables:
- `Children`: Stores information about children in the childcare center
- `Users`: Stores information about staff members (teachers and front desk personnel)
- `InjuryReports`: Stores injury report data with relationships to children and users

## Table Definitions

### Children

**Purpose**: Stores basic information about children in the childcare center who may be involved in injury reports.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Unique identifier for each child |
| name | TEXT | NOT NULL | Child's full name |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | When the record was created |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | When the record was last updated |

**Usage**: Used for dropdown selection in the teacher form and referenced in injury reports.

### Users

**Purpose**: Stores information about staff members who can submit or process injury reports.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Unique identifier for each user |
| name | TEXT | NOT NULL | User's full name |
| role | TEXT | NOT NULL, CHECK (role IN ('Teacher', 'Front Desk')) | User's role in the system |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | When the record was created |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | When the record was last updated |

**Usage**: 
- Teachers can submit new injury reports
- Front desk staff can review and mark reports as delivered to parents

### InjuryReports

**Purpose**: Stores comprehensive information about injury incidents, including details about the injury, actions taken, and processing status.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Unique identifier for each report |
| child_id | UUID | NOT NULL, REFERENCES Children(id) | ID of the injured child |
| submitting_user_id | UUID | NOT NULL, REFERENCES Users(id) | ID of the teacher submitting the report |
| injury_timestamp | TIMESTAMP WITH TIME ZONE | NOT NULL | When the injury occurred |
| location | TEXT | NOT NULL | Where the injury occurred |
| incident_description | TEXT | NOT NULL | Description of how the injury happened |
| injury_description | TEXT | NOT NULL | Description of the injury itself |
| action_taken | TEXT | NOT NULL | Actions taken to address the injury |
| is_bite | BOOLEAN | DEFAULT FALSE | Whether the injury was a bite |
| biter_child_id | UUID | REFERENCES Children(id) | ID of the child who bit (if applicable) |
| is_peer_aggression | BOOLEAN | DEFAULT FALSE | Whether the injury involved peer aggression |
| aggressor_child_id | UUID | REFERENCES Children(id) | ID of the aggressive child (if applicable) |
| memo_content | TEXT | | Parent-friendly memo content generated by AI |
| is_reviewed | BOOLEAN | DEFAULT FALSE | Whether the report has been reviewed by front desk |
| reviewed_by_user_id | UUID | REFERENCES Users(id) | ID of the user who reviewed the report |
| reviewed_timestamp | TIMESTAMP WITH TIME ZONE | | When the report was reviewed |
| is_delivered_to_parent | BOOLEAN | DEFAULT FALSE | Whether the report has been delivered to parents |
| delivered_by_user_id | UUID | REFERENCES Users(id) | ID of the user who delivered the report |
| delivered_timestamp | TIMESTAMP WITH TIME ZONE | | When the report was delivered to parents |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | When the record was created |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | When the record was last updated |

**Proposed Additional Columns**:

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| ai_validated | BOOLEAN | DEFAULT FALSE | Whether the report was validated by AI |
| ai_suggestions_count | INTEGER | DEFAULT 0 | Number of suggestions provided by AI validation |
| ai_suggestions_accepted | INTEGER | DEFAULT 0 | Number of AI suggestions accepted by the user |

**Usage**:
- Created when a teacher submits an injury report
- Updated when front desk staff reviews the report
- Updated again when the report is delivered to parents
- AI validation fields track the effectiveness of the AI validation system

## Relationships

1. **InjuryReports to Children** (Many-to-One):
   - Each injury report is associated with one injured child
   - A child can have multiple injury reports over time
   - Foreign key: `InjuryReports.child_id` references `Children.id`

2. **InjuryReports to Users** (Many-to-One, multiple relationships):
   - Each report has one submitting user (teacher)
   - Each report has at most one reviewing user (front desk)
   - Each report has at most one delivering user (front desk)
   - Foreign keys:
     - `InjuryReports.submitting_user_id` references `Users.id`
     - `InjuryReports.reviewed_by_user_id` references `Users.id`
     - `InjuryReports.delivered_by_user_id` references `Users.id`

3. **Bite and Aggression Relationships** (Optional Many-to-One):
   - If the injury is a bite, it can reference another child as the biter
   - If the injury involves peer aggression, it can reference another child as the aggressor
   - Foreign keys:
     - `InjuryReports.biter_child_id` references `Children.id`
     - `InjuryReports.aggressor_child_id` references `Children.id`

## Database Triggers

The schema includes triggers to automatically update the `updated_at` timestamp whenever a record is modified:

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers for each table
CREATE TRIGGER update_children_updated_at
BEFORE UPDATE ON "Children"
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_users_updated_at
BEFORE UPDATE ON "Users"
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_injury_reports_updated_at
BEFORE UPDATE ON "InjuryReports"
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

## Schema Update Instructions

To apply the schema updates for AI validation tracking:

1. Log in to your Supabase dashboard
2. Navigate to the SQL Editor
3. Paste the following SQL and execute it:

```sql
-- Add AI validation fields to InjuryReports table
ALTER TABLE "InjuryReports"
ADD COLUMN IF NOT EXISTS ai_validated BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS ai_suggestions_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS ai_suggestions_accepted INTEGER DEFAULT 0;

-- Add comments explaining the purpose of these fields
COMMENT ON COLUMN "InjuryReports".ai_validated IS 'Whether the report was validated by AI';
COMMENT ON COLUMN "InjuryReports".ai_suggestions_count IS 'Number of suggestions provided by AI validation';
COMMENT ON COLUMN "InjuryReports".ai_suggestions_accepted IS 'Number of AI suggestions accepted by the user';
```

## Data Flow

1. **Creating a New Injury Report**:
   - Teacher selects a child and fills out injury details
   - System inserts a new record into `InjuryReports` with `is_reviewed` and `is_delivered_to_parent` set to `false`
   - If AI validation is used, the system updates the AI validation fields

2. **Reviewing a Report**:
   - Front desk staff selects a report to review
   - System updates the report with `is_reviewed = true`, `reviewed_by_user_id` set to the current user, and `reviewed_timestamp` set to the current time

3. **Delivering a Report**:
   - Front desk staff marks a report as delivered to parents
   - System updates the report with `is_delivered_to_parent = true`, `delivered_by_user_id` set to the current user, and `delivered_timestamp` set to the current time
