<!-- 
Last updated: 2025-04-17 20:50 EDT
NOTE: Update this timestamp whenever the document is updated.
-->

# n8n Interactions

This document explains all interactions between the Injury Reporting App and n8n workflows. It covers the purpose of each interaction, the data sent and received via webhooks, and the formats used.

---

## Overview

The Injury Reporting App integrates with n8n for a combined purpose:

- `REACT_APP_INJURY_REPORT_IMPROVER_URL`

---

## Injury Report Improver Webhook

**Purpose:**
- Validate a submitted injury report using AI
- Provide suggestions or corrections to the report data
- Generate enhanced report content with improvements
- Create a parent-friendly narrative based on the report

**Trigger:**
- Called during the report submission process, before finalizing the report

**Webhook URL:**
- Defined by `REACT_APP_INJURY_REPORT_IMPROVER_URL`

### Sequence of Events
1. Teacher fills out and submits the injury report form
2. Application constructs a focused data payload (6 fields only) and sends via HTTP POST request to the Injury Report Improver webhook
3. n8n workflow receives the payload and performs AI processing using GPT-4.1 Mini
4. n8n returns a response with:
   - For sufficient entries: Enhanced versions of the text with positive feedback
   - For insufficient entries: Guidance on what information is missing
5. Teacher evaluates each attribute improvement, edits or accepts, and then sends back to the AI or submits to the front desk for review
6. Teachers are also presented with a narrative version generated by the AI to the extent it was able to, given the teacher's inputs. The teacher is unable to edit the narrative
7. Only after the teacher approves the content is the complete data sent to Supabase

### Data Sent to n8n
- **Format:** JSON (application/json)
- **Attributes:** (Limited to 6 fields to conserve tokens)

```
{
  "child_name": string,               // Name of the child
  "injury_time_eastern": string,      // Formatted time in Eastern Time (e.g., "2025-04-17 11:30 AM EDT")
  "location": string,                 // Location where the incident occurred
  "incident_description": string,     // Description of the incident
  "injury_description": string,       // Description of the injury
  "action_taken": string              // Actions taken in response
}
```

### Code Node in n8n that transforms the data sent to n8n before it is processed by the AI Agent

```javascript
// Get all input items from the previous node (Webhook)
const items = $input.all();

// Prepare an array to hold the output items for the next node (AI Agent)
const outputItems = [];

// Loop through each item received from the Webhook
for (const item of items) {
  // Access the 'body' object within the JSON payload of the current item
  const inputBody = item.json.body;

  // Check if the inputBody exists to avoid errors
  if (inputBody) {
    // Create a new object containing only the desired attributes
    const extractedData = {
      child_name: inputBody.child_name,
      injury_time_eastern: inputBody.injury_time_eastern,
      location: inputBody.location,
      incident_description: inputBody.incident_description,
      injury_description: inputBody.injury_description,
      action_taken: inputBody.action_taken
    };

    // Create a new output item with the extracted data
    // nesting the extracted data under the "ReportData" key.
    const outputJson = {
      ReportData: extractedData
    };

    // Add the structured data as the 'json' payload for the output item
    outputItems.push({ json: outputJson });
  } else {
    // Optional: Handle cases where the 'body' is missing
    console.warn("Input item did not contain a 'body' object:", item.json);
    // If you want to maintain the structure even for empty cases:
    // outputItems.push({ json: { ReportData: {} } });
  }
}

// Return the array of processed items to be passed to the next node (AI Agent)
return outputItems;
```

### Data Received from n8n Reply via Webhook node
- **Format:** JSON (application/json)
- **Attributes:**

```json
{
  "output": "{\"fieldEvaluations\":[{\"field\":\"incident_description\",\"original\":\"...\",\"status\":\"sufficient|insufficient\",\"suggestion\":\"...\"},...],\"model_name\":\"gpt-4.1-mini-2025-04-17\"}"
}
```

**Important Notes:**
1. The response is a direct object with an `output` property
2. The output property contains a JSON string
3. The JSON string needs to be parsed to access the actual data
4. The parsed output contains two main sections:
   - `fieldEvaluations`: Array of evaluations for each field with status and suggestions
   - `model_name`: Identifier for the AI model that processed the request

### Field Evaluations Structure

Each field evaluation in the response follows this structure:

```json
{
  "field": "incident_description|injury_description|action_taken",
  "original": "The original text entered by the teacher",
  "status": "sufficient|insufficient",
  "suggestion": "Content depends on status"
}
```

For the `suggestion` field:
- If status is **"sufficient"**: Contains an improved version of the original text
- If status is **"insufficient"**: Contains guidance on what information is missing

### Handling the Response

The application implements a straightforward JSON parsing approach for the n8n response:

1. It checks if the response is an object with an output property
2. It parses the JSON string in the output property to access the data
3. It extracts the fieldEvaluations array and processes each evaluation
4. For sufficient entries:
   - It stores the original text for reference
   - It replaces the form field with the improved version
   - It displays positive feedback with a green checkmark
5. For insufficient entries:
   - It stores the original text for reference
   - It clears the form field
   - It displays guidance on what information is missing
   - It uses the suggestion as placeholder text

This approach ensures reliable processing of the n8n webhook response while maintaining code simplicity.

---

## Data Sent to Supabase

After the teacher has reviewed and approved the AI-validated content, the complete report data is sent to Supabase for storage. This happens only after the n8n validation process is complete.

### Complete Data Sent to Supabase
- **Format:** JSON (application/json)
- **Attributes:**

```
{
  "child_id": string,                 // ID of the child
  "child_name": string,               // Name of the child
  "injury_timestamp": string,         // ISO format timestamp for database storage
  "injury_time_eastern": string,      // Formatted time in Eastern Time (e.g., "2025-04-17 11:30 AM EDT")
  "location": string,                 // Location of the incident
  "submitting_user_id": string,       // ID of the submitting user
  "incident_description": string,     // Description of the incident (possibly AI-enhanced)
  "injury_description": string,       // Description of the injury (possibly AI-enhanced)
  "action_taken": string,             // Actions taken in response (possibly AI-enhanced)
  "is_bite": boolean,                 // Whether the injury was a bite
  "biter_child_id": string,           // ID of the biter child (if applicable)
  "is_peer_aggression": boolean,      // Whether the injury was due to peer aggression
  "aggressor_child_id": string,       // ID of the aggressor child (if applicable)
  "ai_validated": boolean,            // Whether the report was validated by AI
  "ai_suggestions_count": number,     // Number of suggestions provided by AI
  "ai_suggestions_accepted": number,  // Number of suggestions accepted by the teacher
  "parent_narrative": string,         // Parent-friendly narrative generated by AI
  "is_reviewed": boolean,             // Whether the report has been reviewed by front desk
  "is_delivered_to_parent": boolean   // Whether the report has been delivered to the parent
}
```

---

## Implementation Impacts and Required Changes

The transition to a combined Injury Report Improver workflow has several implications for the application:

### 1. Environment Variable Updates
- The application code must be updated to use `REACT_APP_INJURY_REPORT_IMPROVER_URL` instead of `REACT_APP_VALIDATION_WEBHOOK_URL`
- The `REACT_APP_MEMO_GENERATION_WEBHOOK_URL` is no longer needed as memo generation is now part of the combined workflow

### 2. Response Parsing Improvements
- The API module has been updated with a streamlined parsing approach focused on the expected format
- The application can now reliably extract data from the n8n response
- Parent narrative extraction has been enhanced to look for the narrative in multiple possible locations

### 3. UI Component Updates
- The form clearly indicates that teachers cannot edit the narrative
- The form handles cases where teacher input is inadequate and n8n has provided appropriate guidance
- For sufficient entries:
   - It shows positive feedback and populates fields with improved text
   - It displays positive feedback with a green checkmark
- For insufficient entries:
   - It shows guidance and clears fields with helpful placeholder text
   - It uses the suggestion as placeholder text

### 4. Error Handling Improvements
- The application implements robust error handling for cases where:
  - The n8n workflow fails or times out
  - The response format is unexpected

### 5. Input Validation
- Clear guidance is provided to teachers about the level of detail required for effective AI processing
- Visual indicators help teachers understand which fields need improvement

### 6. Workflow Changes
- The front desk review process has been updated to reflect that narratives are generated at submission time

---

## n8n AI Agent Prompt

The n8n workflow uses a carefully structured prompt for the AI agent (GPT-4.1 Mini) that:

1. Defines a clear professional role for the AI as a "preschool injury report validator"
2. Provides explicit instructions on how to evaluate each field
3. Specifies exactly what should be in the "suggestion" field based on status:
   - For sufficient entries: An improved version of the text (not just feedback)
   - For insufficient entries: Specific guidance on what information is missing
4. Requires the AI to include its model name in the response

The complete prompt can be found in `/tests/n8nPrompt.md`.

---

## Notes
- All webhook payloads use `Content-Type: application/json`.
- All date and time fields are expected in ISO 8601 or standard time formats.
- Additional fields may be included in the payloads as the schema evolves.
- The application follows a strict sequence where data is only sent to Supabase after the teacher has reviewed and approved the AI-validated content.

---

## Change Log
- *2025-04-17 20:50 EDT*: Added location field to the data sent to n8n to provide better context for incident evaluation.
- *2025-04-17 20:14 EDT*: Clarified that only specific fields are sent to n8n (the 3 descriptions plus child_name and injury_time_eastern) to conserve tokens. Added explicit section about data sent to Supabase and clarified that this happens only after n8n validation is complete.
- *2025-04-17 19:55 EDT*: Updated documentation to reflect enhanced n8n prompt for GPT-4.1 Mini and improved handling of sufficient/insufficient responses.
- *2025-04-17*: Removed ISO timestamp from n8n payload, using only human-readable Eastern Time format.
- *2025-04-17*: Added formatted Eastern Time (`injury_time_eastern`) to the payload to provide human-readable timestamps.
- *2025-04-17*: Added child_name to the payload sent to n8n and updated code to properly extract it from the form data.
- *2025-04-17*: Updated n8n code node documentation to include proper handling of conditional fields.
- *2025-04-17*: Updated documentation to reflect the correct output format (direct object with output property).
- *2025-04-17*: Simplified JSON parsing logic to focus on the expected response format.
- *2025-04-16*: Updated documentation to reflect the transition from separate validation and memo generation workflows to a combined Injury Report Improver approach. Added implementation impacts and required changes.
- *2025-04-16*: Updated to reflect improved JSON parsing logic and removal of data filtering functionality.

---

For more details on the database schema, see `DATABASE_SCHEMA.md`.
For workflow and integration details, see `WORKFLOW.md`.
