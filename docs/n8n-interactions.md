<!-- 
Last updated: 2025-04-17 10:17 EDT
NOTE: Update this timestamp whenever the document is updated.
-->

# n8n Interactions

This document explains all interactions between the Injury Reporting App and n8n workflows. It covers the purpose of each interaction, the data sent and received via webhooks, and the formats used.

---

## Overview

The Injury Reporting App integrates with n8n for a combined purpose:

- `REACT_APP_INJURY_REPORT_IMPROVER_URL`

---

## Injury Report Improver Webhook

**Purpose:**
- Validate a submitted injury report using AI
- Provide suggestions or corrections to the report data
- Generate enhanced report content with improvements
- Create a parent-friendly narrative based on the report

**Trigger:**
- Called during the report submission process, before finalizing the report

**Webhook URL:**
- Defined by `REACT_APP_INJURY_REPORT_IMPROVER_URL`

### Sequence of Events
1. Teacher fills out and submits the injury report form
2. Application constructs the report data payload and sends via HTTP POST request to the Injury Report Improver webhook
3. n8n workflow receives the payload and performs AI processing
4. n8n returns a response with Enhance Report Field Content (If the teacher provided sufficient initial content) or request for better content from teacher. 
5. Teacher evaluates each attribute improvement, edits or accepts, and then sends back to the AI or submits to the front desk for review. 
6. Teachers are also presented with a narrative version generated by the AI to the extent it was able to, given the teacher's inputs. The teacher is unable to edit the narrative. 

### Data Sent to n8n
- **Format:** JSON (application/json)
- **Attributes:**

```
{
  "child_id": string,                 // ID of the child
  "child_name": string,               // Name of the child
  "injury_time_eastern": string,      // Formatted time in Eastern Time (e.g., "2025-04-17 11:30 AM EDT")
  "location": string,                 // Location of the incident
  "submitting_user_id": string,       // ID of the submitting user
  "incident_description": string,     // Description of the incident
  "injury_description": string,       // Description of the injury
  "action_taken": string,             // Actions taken in response
  "is_bite": boolean,                 // Whether the injury was a bite
  "biter_child_id"?: string,          // ID of the biter child (if applicable)
  "is_peer_aggression": boolean,      // Whether the injury was due to peer aggression
  "aggressor_child_id"?: string       // ID of the aggressor child (if applicable)
}
```
### Code Node in n8n that transforms the data sent to n8n before it is processed by the AI Agent

```javascript
// Get all input items from the previous node (Webhook)
const items = $input.all();

// Prepare an array to hold the output items for the next node (AI Agent)
const outputItems = [];

// Loop through each item received from the Webhook
for (const item of items) {
  // Access the 'body' object within the JSON payload of the current item
  const inputBody = item.json.body;

  // Check if the inputBody exists to avoid errors
  if (inputBody) {
    // Create a new object containing only the desired attributes
    const extractedData = {
      child_id: inputBody.child_id,
      child_name: inputBody.child_name,
      injury_time_eastern: inputBody.injury_time_eastern,
      location: inputBody.location,
      submitting_user_id: inputBody.submitting_user_id,
      incident_description: inputBody.incident_description,
      injury_description: inputBody.injury_description,
      action_taken: inputBody.action_taken,
      is_bite: inputBody.is_bite,
      is_peer_aggression: inputBody.is_peer_aggression,
    };

    // Optional: Add conditional fields if they exist
    if (inputBody.is_bite && inputBody.biter_child_id) {
      extractedData.biter_child_id = inputBody.biter_child_id;
    }
    
    if (inputBody.is_peer_aggression && inputBody.aggressor_child_id) {
      extractedData.aggressor_child_id = inputBody.aggressor_child_id;
    }

    // Create the final output structure for the item's JSON payload,
    // nesting the extracted data under the "ReportData" key.
    const outputJson = {
      ReportData: extractedData
    };

    // Add the structured data as the 'json' payload for the output item
    outputItems.push({ json: outputJson });
  } else {
    // Optional: Handle cases where the 'body' is missing
    console.warn("Input item did not contain a 'body' object:", item.json);
    // If you want to maintain the structure even for empty cases:
    // outputItems.push({ json: { ReportData: {} } });
  }
}

// Return the array of processed items to be passed to the next node (AI Agent)
return outputItems;
```

### Data Received from n8n Reply via Webhook node
- **Format:** JSON (application/json)
- **Attributes:**

```
{
  "output": "{\n  \"enhancedReport\": {\n    \"child_name\": \"[child_id]\",\n    \"incident_description_enhanced\": \"[enhanced description]\",\n    \"injury_description_enhanced\": \"[enhanced description]\",\n    \"action_taken_enhanced\": \"[enhanced description]\",\n    \"incident_description\": \"[original]\",\n    \"injury_description\": \"[original]\",\n    \"action_taken\": \"[original]\"\n  },\n  \"suggestions\": [\n    {\n      \"field\": \"incident_description\",\n      \"original\": \"[original text]\",\n      \"suggestion\": \"[suggested improvement]\",\n      \"reason\": \"[reason for suggestion]\"\n    },\n    {\n      \"field\": \"injury_description\",\n      \"original\": \"[original text]\",\n      \"suggestion\": \"[suggested improvement]\",\n      \"reason\": \"[reason for suggestion]\"\n    },\n    {\n      \"field\": \"action_taken\",\n      \"original\": \"[original text]\",\n      \"suggestion\": \"[suggested improvement]\",\n      \"reason\": \"[reason for suggestion]\"\n    }\n  ],\n  \"parent_narrative\": \"[Generated parent-friendly narrative]\"\n}"
}
```

**Important Notes:**
1. The response is a direct object with an `output` property
2. The output property contains a JSON string
3. The JSON string needs to be parsed to access the actual data
4. The parsed output contains three main sections:
   - `enhancedReport`: Enhanced versions of the submitted fields
   - `suggestions`: Specific suggestions for improving each field
   - `parent_narrative`: A complete parent-friendly narrative generated from the injury report

### Handling the Response

The application implements a straightforward JSON parsing approach for the n8n response:

1. It checks if the response is an object with an output property
2. It parses the JSON string in the output property to access the data
3. It handles errors appropriately if parsing fails or if the format is unexpected

This approach ensures reliable processing of the n8n webhook response while maintaining code simplicity.

---

## Implementation Impacts and Required Changes

The transition to a combined Injury Report Improver workflow has several implications for the application:

### 1. Environment Variable Updates
- The application code must be updated to use `REACT_APP_INJURY_REPORT_IMPROVER_URL` instead of `REACT_APP_VALIDATION_WEBHOOK_URL`
- The `REACT_APP_MEMO_GENERATION_WEBHOOK_URL` is no longer needed as memo generation is now part of the combined workflow

### 2. Response Parsing Improvements
- The API module has been updated with a streamlined parsing approach focused on the expected format
- The application can now reliably extract data from the n8n response
- Parent narrative extraction has been enhanced to look for the narrative in multiple possible locations

### 3. UI Component Updates
- The form should clearly indicate that teachers cannot edit the narrative
- The form should handle cases where teacher input is inadequate and n8n has provided appropriate guidance to teacher

### 4. Error Handling Improvements
- The application should implement robust error handling for cases where:
  - The n8n workflow fails or times out
  - The response format is unexpected

### 5. Input Validation
- Clear guidance should be provided to teachers about the level of detail required for effective AI processing

### 6. Workflow Changes
- The front desk review process should be updated to reflect that narratives are generated at submission time

---

## Notes
- All webhook payloads use `Content-Type: application/json`.
- All date and time fields are expected in ISO 8601 or standard time formats.
- Additional fields may be included in the payloads as the schema evolves.
- Webhook URLs should be kept secret and managed via environment variables.
- The AI should be configured to detect inadequate input and provide specific guidance for improvement rather than generating content from minimal information.

---

## Change Log
- *2025-04-17*: Removed ISO timestamp from n8n payload, using only human-readable Eastern Time format.
- *2025-04-17*: Added formatted Eastern Time (`injury_time_eastern`) to the payload to provide human-readable timestamps.
- *2025-04-17*: Added child_name to the payload sent to n8n and updated code to properly extract it from the form data.
- *2025-04-17*: Updated n8n code node documentation to include proper handling of conditional fields.
- *2025-04-17*: Updated documentation to reflect the correct output format (direct object with output property).
- *2025-04-17*: Simplified JSON parsing logic to focus on the expected response format.
- *2025-04-16*: Updated documentation to reflect the transition from separate validation and memo generation workflows to a combined Injury Report Improver approach. Added implementation impacts and required changes.
- *2025-04-16*: Updated to reflect improved JSON parsing logic and removal of data filtering functionality.

---

For more details on the database schema, see `DATABASE_SCHEMA.md`.
For workflow and integration details, see `WORKFLOW.md`.
