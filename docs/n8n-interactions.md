# n8n Interactions

This document explains all interactions between the Injury Reporting App and n8n workflows. It covers the purpose of each interaction, the data sent and received via webhooks, and the formats used.

---

## Overview

The Injury Reporting App integrates with n8n for a combined purpose:

**Injury Report Improver**: To validate injury reports using AI, return suggestions for improvement, and generate a parent-friendly narrative.

This integration is performed via an HTTP webhook configured in the app's environment variable:

- `REACT_APP_INJURY_REPORT_IMPROVER_URL`

---

## Injury Report Improver Webhook

**Purpose:**
- Validate a submitted injury report using AI
- Provide suggestions or corrections to the report data
- Generate enhanced report content with improvements
- Create a parent-friendly narrative based on the report

**Trigger:**
- Called during the report submission process, before finalizing the report

**Webhook URL:**
- Defined by `REACT_APP_INJURY_REPORT_IMPROVER_URL`

### Sequence of Events
1. User fills out and submits the injury report form
2. Application constructs the report data payload and sends via HTTP POST request to the Injury Report Improver webhook
3. n8n workflow receives the payload and performs AI processing
4. n8n returns a response with Enhance Report Field Content (If the teacher provided sufficient initial content) or request for better content from teacher. 
5. Teacher evaluates each attribute improvement, edits or accepts, and then sends back to the AI or submits to the front desk for review. 
6. Teachers are also presented with a narrative version generated by the AI to the extent it was able to, given the teacher's inputs. The teacher is unable to edit the narrative. 

### Data Sent to n8n
- **Format:** JSON (application/json)
- **Attributes:**

```
{
  "child_id": string,                 // ID of the child
  "injury_timestamp": string,         // Date and time of the incident (ISO 8601)
  "location": string,                 // Location of the incident
  "submitting_user_id": string,       // ID of the submitting user
  "incident_description": string,     // Description of the incident
  "injury_description": string,       // Description of the injury
  "action_taken": string,             // Actions taken in response
  "is_bite": boolean,                 // Whether the injury was a bite
  "biter_child_id"?: string,          // ID of the biter child (if applicable)
  "is_peer_aggression": boolean,      // Whether the injury was due to peer aggression
  "aggressor_child_id"?: string       // ID of the aggressor child (if applicable)
}
```

**Note:** All fields are sent directly to the n8n webhook without any filtering or modification.

### Data Received from n8n
- **Format:** JSON (application/json)
- **Attributes:**

```
[
  {
    "output": "{\n  \"enhancedReport\": {\n    \"child_name\": \"[child_id]\",\n    \"incident_description_enhanced\": \"[enhanced description]\",\n    \"injury_description_enhanced\": \"[enhanced description]\",\n    \"action_taken_enhanced\": \"[enhanced description]\",\n    \"incident_description\": \"[original]\",\n    \"injury_description\": \"[original]\",\n    \"action_taken\": \"[original]\"\n  },\n  \"suggestions\": [\n    {\n      \"field\": \"incident_description\",\n      \"original\": \"[original text]\",\n      \"suggestion\": \"[suggested improvement]\",\n      \"reason\": \"[reason for suggestion]\"\n    },\n    {\n      \"field\": \"injury_description\",\n      \"original\": \"[original text]\",\n      \"suggestion\": \"[suggested improvement]\",\n      \"reason\": \"[reason for suggestion]\"\n    },\n    {\n      \"field\": \"action_taken\",\n      \"original\": \"[original text]\",\n      \"suggestion\": \"[suggested improvement]\",\n      \"reason\": \"[reason for suggestion]\"\n    }\n  ],\n  \"parent_narrative\": \"[Generated parent-friendly narrative]\"\n}"
  }
]
```

**Important Notes:**
1. The response is an array containing a single object
2. The object has an `output` property that contains a JSON string (with escape characters)
3. The JSON string needs to be parsed to access the actual data
4. The parsed output contains three main sections:
   - `enhancedReport`: Enhanced versions of the submitted fields
   - `suggestions`: Specific suggestions for improving each field
   - `parent_narrative`: A complete parent-friendly narrative generated from the injury report

### Handling the Response

The application implements a robust JSON parsing strategy to handle the nested JSON structure:

1. First, it attempts standard JSON parsing on the response
2. If that fails, it cleans the string by handling escape characters and malformed JSON object markers
3. If both approaches fail, it uses regex pattern matching to extract valid JSON content

This multi-tiered approach ensures reliable parsing of the n8n response regardless of formatting variations.

The application handles multiple response formats:
- Direct object with output property (most common)
- Array with objects containing output property
- Direct JSON string

After parsing, the application extracts:
- The enhancedReport object
- Suggestions for field improvements
- The parent narrative (from various possible locations in the response)

### Example Response
<!-- Example removed as it showed inadequate handling of minimal teacher input -->

---

## Implementation Impacts and Required Changes

The transition to a combined Injury Report Improver workflow has several implications for the application:

### 1. Environment Variable Updates
- The application code must be updated to use `REACT_APP_INJURY_REPORT_IMPROVER_URL` instead of `REACT_APP_VALIDATION_WEBHOOK_URL`
- The `REACT_APP_MEMO_GENERATION_WEBHOOK_URL` is no longer needed as memo generation is now part of the combined workflow

### 2. Response Parsing Improvements
- The API module has been updated with a robust multi-tiered parsing approach to handle various response formats
- The application can now reliably extract data from different structures in the n8n response
- Parent narrative extraction has been enhanced to look for the narrative in multiple possible locations

### 3. UI Component Updates
- The TeacherForm component needs to be enhanced to display the parent narrative generated by the AI
- The form should clearly indicate that teachers cannot edit the narrative
- The form should handle cases where teacher input is inadequate and display appropriate guidance

### 4. Error Handling Improvements
- The application should implement robust error handling for cases where:
  - The n8n workflow fails or times out
  - The response format is unexpected
  - The AI is unable to generate meaningful suggestions or narrative due to insufficient input

### 5. Input Validation
- The application should implement client-side validation to prevent submission of minimal or inadequate inputs
- Clear guidance should be provided to teachers about the level of detail required for effective AI processing

### 6. Workflow Changes
- The submission process now includes both validation and narrative generation in a single step
- The front desk review process should be updated to reflect that narratives are generated at submission time

---

## Notes
- All webhook payloads use `Content-Type: application/json`.
- All date and time fields are expected in ISO 8601 or standard time formats.
- Additional fields may be included in the payloads as the schema evolves.
- Webhook URLs should be kept secret and managed via environment variables.
- The AI should be configured to detect inadequate input and provide specific guidance for improvement rather than generating content from minimal information.

---

## Change Log
- *2025-04-16*: Updated documentation to reflect the transition from separate validation and memo generation workflows to a combined Injury Report Improver approach. Added implementation impacts and required changes.
- *2025-04-16*: Updated to reflect improved JSON parsing logic and removal of data filtering functionality.

---

For more details on the database schema, see `DATABASE_SCHEMA.md`.
For workflow and integration details, see `WORKFLOW.md`.
